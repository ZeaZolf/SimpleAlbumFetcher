var j=Object.defineProperty;var M=(s,e)=>{for(var t in e)j(s,t,{get:e[t],enumerable:!0})};function W(s){return s.replace(/\s\(\d+\)$/,"")}function o(s){if(!s||!Object.keys(s).length)return"";let e=new URLSearchParams;for(let[t,r]of Object.entries(s))e.set(t,r.toString());return"?"+e.toString()}function n(s){return encodeURIComponent(s)}function v(s,e){for(let t in e){let r=e[t];F(r)?s[t]=v(Array.isArray(r)?[]:{},r):s[t]=r}return s}function F(s){return s&&typeof s=="object"}var f=fetch,A=globalThis.Headers;var c=class extends Error{constructor(e,t){super(t||"Unknown error."),this.name=this.constructor.name,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,this.constructor),this.statusCode=e||404}toString(){return this.name+": "+this.statusCode+" "+this.message}},d=class extends c{constructor(){super(401,"You must authenticate to access this resource."),this.name=this.constructor.name,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,this.constructor)}};function G(s){return{status:{accepted:"Accepted",draft:"Draft",deleted:"Deleted",rejected:"Rejected"},getArtist:function(e){return s.get("/artists/"+e)},getArtistReleases:function(e,t){let r=`/artists/${e}/releases${o(t)}`;return s.get(r)},getRelease:function(e,t){let r=`/releases/${e}`;return t!==void 0&&(r+=`${o({curr_abbr:t})}`),s.get(r)},getReleaseRating:function(e,t){return s.get(`/releases/${e}/rating/${n(t)}`)},setReleaseRating:function(e,t,r){let i=`/releases/${e}/rating/${n(t)}`;return r?s.put({url:i,authLevel:2},{rating:r>5?5:r}):s.delete({url:i,authLevel:2})},getReleaseCommunityRating:function(e){let t=`/releases/${e}/rating`;return s.get(t)},getReleaseStats:function(e){let t=`/releases/${e}/stats`;return s.get(t)},getMaster:function(e){return s.get(`/masters/${e}`)},getMasterVersions:function(e,t){let r=`/masters/${e}/versions${o(t)}`;return s.get(r)},getLabel:function(e){return s.get(`/labels/${e}`)},getLabelReleases:function(e,t){let r=`/labels/${e}/releases${o(t)}`;return s.get(r)},search:function(e={}){let{query:t,...r}=e,i=t?Object.assign(r,{q:t}):r;return s.get({url:`/database/search${o(i)}`,authLevel:1})}}}function S(s){return{getFolders:function(e){return s.get(`/users/${n(e)}/collection/folders`)},getFolder:function(e,t){return s.authenticated(2)||Number(t)===0?s.get(`/users/${n(e)}/collection/folders/${t}`):Promise.reject(new d)},addFolder:function(e,t){return s.post({url:`/users/${n(e)}/collection/folders`,authLevel:2},{name:t})},setFolderName:function(e,t,r){return s.post({url:`/users/${n(e)}/collection/folders/${t}`,authLevel:2},{name:r})},deleteFolder:function(e,t){return s.delete({url:`/users/${n(e)}/collection/folders/${t}`,authLevel:2})},getReleases:function(e,t,r){if(s.authenticated(2)||Number(t)===0){let i=`/users/${n(e)}/collection/folders/${t}/releases${o(r)}`;return s.get(i)}return Promise.reject(new d)},getReleaseInstances:function(e,t){return s.get(`/users/${n(e)}/collection/releases/${t}`)},addRelease:function(e,t,r=1){return s.post({url:`/users/${n(e)}/collection/folders/${r}/releases/${t}`,authLevel:2},void 0)},editRelease:function(e,t,r,i,m){return s.post({url:`/users/${n(e)}/collection/folders/${t}/releases/${r}/instances/${i}`,authLevel:2},m)},removeRelease:function(e,t,r,i){return s.delete({url:`/users/${n(e)}/collection/folders/${t}/releases/${r}/instances/${i}`,authLevel:2})},getFields:function(e){return s.get(`/users/${n(e)}/collection/fields`)},editInstanceNote:function(e,t,r,i,m,u){let p=`/users/${n(e)}/collection/folders/${t}/releases/${r}/instances/${i}/fields/${m}`;return s.post(p,{value:u})},getValue:function(e){return s.get({url:`/users/${n(e)}/collection/value`,authLevel:2})}}}function k(s){return{getItems:function(e){let t=`/lists/${n(e.toString())}`;return s.get(t)}}}function w(s){return{getReleases:function(e,t){let r=`/users/${n(e)}/wants${o(t)}`;return s.get(r)},addRelease:function(e,t,r){return s.put({url:`/users/${n(e)}/wants/${t}`,authLevel:2},r)},editNotes:function(e,t,r){return s.post({url:`/users/${n(e)}/wants/${t}`,authLevel:2},r)},removeRelease:function(e,t){return s.delete({url:`/users/${n(e)}/wants/${t}`,authLevel:2})}}}function h(s){return{getProfile:function(e){return s.get(`/users/${n(e)}`)},editProfile:function(e,t){return s.post(`/users/${n(e)}`,t)},getInventory:function(e,t){let r=`/users/${n(e)}/inventory${o(t)}`;return s.get(r)},getIdentity:s.getIdentity,collection:function(){return S(s)},wantlist:function(){return w(s)},list:function(){return k(s)},getContributions:function(e,t){let r=`/users/${n(e)}/contributions${o(t)}`;return s.get(r)},getSubmissions:function(e,t){let r=`/users/${n(e)}/submissions${o(t)}`;return s.get(r)},getLists:function(e,t){let r=`/users/${n(e)}/lists${o(t)}`;return s.get(r)}}}function C(s){return{getInventory:h(s).getInventory,getListing:function(e,t){let r=`/marketplace/listings/${e}`;return t!==void 0&&(r+=`${o({curr_abbr:t})}`),s.get(r)},addListing:function(e){return s.post({url:"/marketplace/listings",authLevel:2},e)},editListing:function(e,t){return s.post({url:`/marketplace/listings/${e}`,authLevel:2},t)},deleteListing:function(e){return s.delete({url:`/marketplace/listings/${e}`,authLevel:2})},getOrders:function(e){let t=`/marketplace/orders${o(e)}`;return s.get({url:t,authLevel:2})},getOrder:function(e){return s.get({url:`/marketplace/orders/${e}`,authLevel:2})},editOrder:function(e,t){return s.post({url:`/marketplace/orders/${e}`,authLevel:2},t)},getOrderMessages:function(e,t){let r=`/marketplace/orders/${e}/messages${o(t)}`;return s.get({url:r,authLevel:2})},addOrderMessage:function(e,t){return s.post({url:"/marketplace/orders/"+e+"/messages",authLevel:2},t)},getFee:function(e,t){let r=`/marketplace/fee/${e.toFixed(2)}`;return t&&(r+="/"+t),s.get(r)},getPriceSuggestions:function(e){return s.get({url:`/marketplace/price_suggestions/${e}`,authLevel:2})},getReleaseStats:function(e,t){let r=`/marketplace/stats/${e}`;return t&&(r+=`${o({curr_abbr:t})}`),s.get(r)}}}function O(s){return{exportInventory:function(){return s.post("/inventory/export",{}).then(t=>({rateLimit:t.rateLimit,data:void 0}))},getExports:function(e){return s.get(`/inventory/export${o(e)}`)},getExport:function(e){return s.get(`/inventory/export/${e}`)},downloadExport:function(e){return s.get({url:`/inventory/export/${e}/download`,json:!1})}}}var P={};M(P,{randomBytes:()=>b});function b(s){return{toString(e){return window.crypto.randomUUID().slice(0,64)}}}var D="4.1.2",N="https://github.com/lionralfs/discogs-client",I=`@lionralfs/discogs-client/${D} +${N}`,x=class{constructor(e,t){this.consumerKey=e,this.consumerSecret=t}async getRequestToken(e){let t=this.consumerKey,r=this.consumerSecret,i=Date.now(),m=b(64).toString("hex"),u=await f("https://api.discogs.com/oauth/request_token",{method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`OAuth oauth_consumer_key="${t}", oauth_nonce="${m}", oauth_signature="${r}&", oauth_signature_method="PLAINTEXT", oauth_timestamp="${i}", oauth_callback="${encodeURIComponent(e)}"`,"User-Agent":I}});if(u.status!==200){let l="Unknown Error.";try{l=await u.text()}catch{}throw new c(u.status,l)}let p=await u.text(),g=new URLSearchParams(p),a=g.get("oauth_token");return{token:a,tokenSecret:g.get("oauth_token_secret"),callbackConfirmed:g.get("oauth_callback_confirmed")==="true",authorizeUrl:`https://discogs.com/oauth/authorize?oauth_token=${a}`}}async getAccessToken(e,t,r){let i=this.consumerKey,m=this.consumerSecret,u=Date.now(),p=b(64).toString("hex"),g=await f("https://api.discogs.com/oauth/access_token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`OAuth oauth_consumer_key="${i}", oauth_nonce="${p}", oauth_token="${e}", oauth_signature="${m}&${t}", oauth_signature_method="PLAINTEXT", oauth_timestamp="${u}", oauth_verifier="${r}"`,"User-Agent":I}});if(g.status!==200){let R="Unknown Error.";try{R=await g.text()}catch{}throw new c(g.status,R)}let a=await g.text(),l=new URLSearchParams(a);return{accessToken:l.get("oauth_token"),accessTokenSecret:l.get("oauth_token_secret")}}};function T(s,e,t,r,i,m){let u=m.randomBytes(32).toString("hex",0,64),p=Math.floor(i.now()/1e3);return`OAuth oauth_consumer_key="${s}", oauth_token="${t}", oauth_signature_method="PLAINTEXT", oauth_signature="${e}&${r}", oauth_timestamp="${p}", oauth_nonce="${u}", oauth_token_secret="${r}", oauth_version="1.0"`}function q(s,e){return typeof s=="object"&&s!==null&&e in s}var E="4.1.2",U="https://github.com/lionralfs/discogs-client",B=`@lionralfs/discogs-client/${E} +${U}`,V={host:"api.discogs.com",port:443,userAgent:B,apiVersion:"v2",outputFormat:"discogs",exponentialBackoffMaxRetries:0,exponentialBackoffIntervalMs:2e3,exponentialBackoffRate:2.7},$=class{constructor(e={}){this.getIdentity=()=>this.get({url:"/oauth/identity",authLevel:2});if(this.config=Object.assign({},V),typeof e.userAgent=="string"&&(this.config.userAgent=e.userAgent),this.auth=void 0,typeof e.auth=="object"){this.auth={};let t=Object.assign({},e.auth);Object.prototype.hasOwnProperty.call(t,"method")?this.auth.method=t.method:this.auth.method="discogs",Object.prototype.hasOwnProperty.call(t,"level")||(t.userToken?(this.auth.userToken=t.userToken,this.auth.level=2):t.consumerKey&&t.consumerSecret&&(this.auth.consumerKey=t.consumerKey,this.auth.consumerSecret=t.consumerSecret,t.accessToken&&t.accessTokenSecret?(this.auth.accessToken=t.accessToken,this.auth.accessTokenSecret=t.accessTokenSecret,this.auth.level=2):this.auth.level=1))}}setConfig(e){return v(this.config,e),this}authenticated(e=0){return typeof this.auth=="object"&&this.auth.level!==void 0&&this.auth.level>=e}async about(){let e={version:E,userAgent:this.config.userAgent,authMethod:this.auth?this.auth.method:"none",authLevel:this.auth?this.auth.level:0},t=await this.get("");return t.data.clientInfo=e,t}rawRequest(e,t,r=0){let i=e.data||null,m=e.method||"GET",u=new URL(e.url,`https://${this.config.host}`);u.port=this.config.port.toString();let p=new A({"User-Agent":this.config.userAgent,Accept:`application/vnd.discogs.${this.config.apiVersion}.${this.config.outputFormat}+json`}),g={method:m,headers:p};if(i&&(typeof i=="object"&&(g.body=JSON.stringify(i)),p.set("Content-Type","application/json")),this.auth&&(this.auth.consumerKey||this.auth.userToken)){let a="";this.auth.method==="oauth"?a=T(this.auth.consumerKey,this.auth.consumerSecret,this.auth.accessToken,this.auth.accessTokenSecret,{now:()=>Date.now()},P):this.auth.method==="discogs"&&(a="Discogs",this.auth.userToken?a+=" token="+this.auth.userToken:this.auth.consumerKey&&(a+=" key="+this.auth.consumerKey+", secret="+this.auth.consumerSecret)),p.set("Authorization",a)}f(u.toString(),g).then(async a=>{let l=a.status;if(l===429&&r<this.config.exponentialBackoffMaxRetries){let L=this.config.exponentialBackoffIntervalMs*Math.pow(this.config.exponentialBackoffRate,r);setTimeout(()=>{this.rawRequest(e,t,r+1)},L);return}let R,_;a.headers.get("x-discogs-ratelimit")&&(R={limit:Number(a.headers.get("x-discogs-ratelimit")),used:Number(a.headers.get("x-discogs-ratelimit-used")),remaining:Number(a.headers.get("x-discogs-ratelimit-remaining"))});let y;if(e.json?y=await a.json().catch(()=>{}):y=a,l>399){let L=q(y,"message")&&typeof y.message=="string"?y.message:"";_=new c(l,L)}t(_,y,R)}).catch(a=>{t(a)})}async request(e){return Object.prototype.hasOwnProperty.call(e,"json")||(e.json=!0),new Promise((t,r)=>{let i=()=>{this.rawRequest(e,function(m,u,p){if(m)return r(m);t({data:u,rateLimit:p})})};if(e.authLevel&&!this.authenticated(e.authLevel))throw new d;i()})}get(e){return typeof e=="string"&&(e={url:e}),this.request(e)}post(e,t){return typeof e=="string"&&(e={url:e}),e.method="POST",e.data=t,this.request(e)}put(e,t){return typeof e=="string"&&(e={url:e}),e.method="PUT",e.data=t,this.request(e)}delete(e){return typeof e=="string"&&(e={url:e}),e.method="DELETE",this.request(e)}database(){return G(this)}marketplace(){return C(this)}inventory(){return O(this)}user(){return h(this)}};export{$ as DiscogsClient,x as DiscogsOAuth,n as escape,v as merge,W as stripVariation,o as toQueryString};
